# Документация по обучению модели безопасности полёта дронов

## Обзор

Этот проект реализует систему машинного обучения для оценки безопасности полёта дронов на основе:
- Паспортных характеристик дронов (лимиты по ветру, температуре, осадкам)
- Исторических погодных данных (температура, ветер, осадки, облачность)

Модель предсказывает **индекс безопасности** (0-100) и **класс безопасности** (green/yellow/red) для комбинации дрон + погодные условия.

---

## Структура проекта

```
guardian-ai/
├── data/
│   ├── drone_specs.csv      # Паспортные данные дронов (42 модели)
│   ├── data.grib            # Погодные данные в формате GRIB
│   └── weather.csv          # Конвертированные погодные данные (CSV)
├── docs/
│   ├── dataset_drone_specs_summary.md
│   └── model_training_documentation.md  # Этот файл
└── train_safety_model.py    # Основной скрипт обучения
```

---

## Описание данных

### 1. Паспортные данные дронов (`drone_specs.csv`)

**Структура:**
- `drone_id` — уникальный идентификатор дрона
- `brand`, `model` — производитель и модель
- `category` — категория (multirotor/fixed_wing/hybrid_vtol/vtol)
- `max_wind_mps` — максимальная допустимая скорость ветра (м/с)
- `temp_min_c`, `temp_max_c` — диапазон рабочих температур (°C)
- `allow_precip_mmph` — допустимые осадки (мм/ч, 0 = запрещены)
- `min_visibility_km` — минимальная видимость для полёта (км)
- `ip_rating` — защита от влаги/пыли (IP43, IP45, IP53, IP55)
- `mtow_kg` — максимальный вес при взлёте (кг)
- `weight_kg` — вес дрона (кг)
- `max_flight_time_min` — максимальное время полёта (мин)

**Статистика:**
- 42 модели дронов
- 20 брендов (DJI, Parrot, Autel, Skydio и др.)
- 4 категории (32 мультикоптера, 5 гибридных VTOL, 4 фиксированное крыло, 1 VTOL)

### 2. Погодные данные (`data.grib` → `weather.csv`)

**Формат входных данных:**
- GRIB (Gridded Binary) — стандартный формат для метеорологических данных
- Содержит переменные: температура, компоненты ветра (u/v), порывы ветра, осадки, облачность
- Координаты: время, широта, долгота

**Структура выходного CSV (`weather.csv`):**
- `timestamp` — временная метка
- `lat`, `lon` — координаты (широта, долгота)
- `temp_c` — температура воздуха на 2м (°C)
- `wind_u`, `wind_v` — компоненты ветра на 10м (м/с)
- `wind_speed` — скорость ветра (м/с) = √(wind_u² + wind_v²)
- `wind_gust` — порывы ветра (м/с)
- `precip` — осадки (мм/ч)
- `cloud_cover` — облачность (0-100%)

**Примечание:** Если GRIB файл недоступен или не может быть прочитан, скрипт автоматически генерирует синтетические погодные данные для демонстрации работы модели.

---

## Алгоритм расчёта индекса безопасности

### Формулы штрафов

#### 1. Штраф за скорость ветра (`calc_wind_penalty`)
```
wind_ratio = wind_speed / max_wind_mps

Если wind_ratio <= 0.7:
    penalty = wind_ratio * 5
Если 0.7 < wind_ratio <= 1.0:
    penalty = 3.5 + (wind_ratio - 0.7) * 20
Если wind_ratio > 1.0:
    penalty = 3.5 + 6 + (wind_ratio - 1.0) * 30
```

#### 2. Штраф за порывы ветра (`calc_gust_penalty`)
```
gust_ratio = wind_gust / max_wind_mps

Если gust_ratio <= 1.0:
    penalty = 0
Если 1.0 < gust_ratio <= 1.3:
    penalty = (gust_ratio - 1.0) * 20
Если gust_ratio > 1.3:
    penalty = 6 + (gust_ratio - 1.3) * 25
```

#### 3. Штраф за температуру (`calc_temp_penalty`)
```
temp_below = max(0, temp_min_c - temp_c)
temp_above = max(0, temp_c - temp_max_c)

penalty = temp_below * 1.0 + temp_above * 0.7
penalty = min(penalty, 20.0)  # Ограничение до 20 баллов
```

#### 4. Штраф за осадки (`calc_precip_penalty`)
```
Если allow_precip == 0 и precip > 0:
    penalty = min(precip * 10, 15.0)
Если allow_precip > 0:
    excess = max(0, precip - allow_precip)
    penalty = min(excess * 5, 15.0)
Иначе:
    penalty = 0
```

#### 5. Штраф за видимость (`calc_visibility_penalty`)
```
Если vis_km >= min_visibility_km:
    penalty = 0
Иначе:
    deficit = min_visibility_km - vis_km
    penalty = min(deficit * 5, 10.0)
```

### Итоговый индекс безопасности

```python
total_penalty = p_wind + p_gust + p_temp + p_precip + p_vis
safety_index = max(0, min(100, 100 - total_penalty))
```

### Класс безопасности

```python
if safety_index >= 80:
    safety_class = "green"   # Безопасно
elif safety_index >= 60:
    safety_class = "yellow"  # Осторожно
else:
    safety_class = "red"     # Опасно
```

---

## Инженерные признаки

Помимо исходных признаков, в модель добавляются следующие инженерные признаки:

1. **`wind_ratio`** = `wind_speed / max_wind_mps` — отношение скорости ветра к максимуму
2. **`gust_ratio`** = `wind_gust / max_wind_mps` — отношение порывов к максимуму
3. **`temp_below`** = `max(0, temp_min_c - temp_c)` — отклонение температуры ниже минимума
4. **`temp_above`** = `max(0, temp_c - temp_max_c)` — отклонение температуры выше максимума
5. **`precip_excess`** = `max(0, precip - allow_precip_mmph)` — превышение осадков над допустимым

---

## Модель машинного обучения

### Архитектура
- **Алгоритм:** XGBoost Regressor (fallback: RandomForestRegressor)
- **Задача:** Регрессия (предсказание `safety_index` 0-100)
- **Objective:** `reg:squarederror`

### Гиперпараметры XGBoost
- `n_estimators`: 100
- `max_depth`: 6
- `learning_rate`: 0.1
- `random_state`: 42

### Признаки модели

**Погодные признаки:**
- `temp_c`, `wind_speed`, `wind_gust`, `precip`, `cloud_cover`

**Паспортные признаки:**
- `max_wind_mps`, `temp_min_c`, `temp_max_c`, `allow_precip_mmph`
- `min_visibility_km`, `mtow_kg`, `weight_kg`, `max_flight_time_min`

**Инженерные признаки:**
- `wind_ratio`, `gust_ratio`, `temp_below`, `temp_above`, `precip_excess`, `visibility_km`

**Категориальные признаки (one-hot):**
- `category_multirotor`, `category_fixed_wing`, `category_hybrid_vtol`, `category_vtol`

### Метрики качества

Модель оценивается по следующим метрикам:
- **MAE** (Mean Absolute Error) — средняя абсолютная ошибка
- **RMSE** (Root Mean Squared Error) — корень из средней квадратичной ошибки
- **R²** (Coefficient of Determination) — коэффициент детерминации

---

## Использование

### Установка зависимостей

```bash
pip install pandas numpy scikit-learn xgboost

# Для работы с GRIB файлами (опционально):
pip install cfgrib xarray eccodes
```

### Запуск обучения

```bash
python train_safety_model.py
```

### Что делает скрипт

1. **Загружает данные о дронах** из `data/drone_specs.csv`
2. **Конвертирует GRIB файл** `data/data.grib` → `data/weather.csv`
   - Если GRIB недоступен, генерирует синтетические данные
3. **Создаёт обучающий датасет:**
   - Объединяет данные дронов и погоды
   - Вычисляет инженерные признаки
   - Рассчитывает `safety_index` и `safety_class`
4. **Обучает модель:**
   - Разделяет данные на train/test (80/20)
   - Обучает XGBoost модель
5. **Оценивает качество:**
   - Вычисляет метрики на тестовой выборке
   - Выводит примеры предсказаний
   - Показывает топ-10 важных признаков

### Вывод скрипта

Скрипт выводит в консоль:
1. Информацию о загруженных данных (размер, столбцы, типы)
2. Результаты конвертации GRIB файла (переменные, координаты)
3. Статистику обучающего датасета
4. Метрики обучения (MAE, RMSE, R²)
5. Примеры предсказаний (первые 10 строк)
6. Топ-10 важных признаков модели

---

## Примеры использования модели

После обучения модель можно использовать для предсказания безопасности полёта:

```python
import pandas as pd
import xgboost as xgb

# Загрузка обученной модели
model = xgb.XGBRegressor()
model.load_model('safety_model.json')  # Если сохранена

# Подготовка данных для предсказания
new_data = pd.DataFrame({
    'temp_c': [15.0],
    'wind_speed': [8.0],
    'wind_gust': [10.0],
    'precip': [0.0],
    'cloud_cover': [30.0],
    'max_wind_mps': [12.0],
    'temp_min_c': [-10.0],
    'temp_max_c': [40.0],
    # ... остальные признаки
})

# Предсказание
safety_index = model.predict(new_data)[0]
safety_class = "green" if safety_index >= 80 else ("yellow" if safety_index >= 60 else "red")
```

---

## Ограничения и улучшения

### Текущие ограничения

1. **Синтетические данные:** Если GRIB файл недоступен, используются синтетические данные
2. **Видимость:** Видимость генерируется случайно, так как её нет в исходных данных
3. **Простота модели:** Используется базовая модель XGBoost без тюнинга гиперпараметров

### Возможные улучшения

1. **Тюнинг гиперпараметров:** Использовать GridSearchCV или Optuna для оптимизации
2. **Дополнительные признаки:** Добавить признаки времени суток, сезона, высоты полёта
3. **Ансамбли моделей:** Объединить несколько моделей для улучшения точности
4. **Валидация на реальных данных:** Протестировать на реальных исторических данных полётов
5. **Интерпретируемость:** Использовать SHAP для объяснения предсказаний

---

## Технические детали реализации

### Обработка GRIB файлов

Скрипт использует библиотеки `cfgrib` и `xarray` для чтения GRIB файлов:
- Автоматически определяет переменные по стандартным именам (t2m, u10, v10, tp, tcc)
- Конвертирует температуру из Кельвинов в Цельсии (если > 200)
- Конвертирует осадки из метров в мм/ч (если < 0.1)
- Нормализует облачность до 0-100%

### Генерация синтетических данных

Если GRIB файл недоступен:
- Генерируется временной ряд (30 дней, каждые 3 часа)
- Создаётся сетка координат (5x5 точек)
- Температура: сезонная вариация + случайность
- Ветер: базовый + случайные порывы
- Осадки: редкие события (10% вероятность)
- Облачность: равномерное распределение 0-100%

### Обработка пропусков

- Все пропуски заполняются нулями
- Для порывов ветра: если отсутствуют, оцениваются как `wind_speed * 1.3`

---

## Автор и лицензия

Проект создан для оценки безопасности полёта дронов на основе метеорологических данных и паспортных характеристик.

---

## Контакты и поддержка

Для вопросов и предложений по улучшению модели обращайтесь к разработчикам проекта.
